# 技术决策记录 (Architecture Decision Records)

**Change ID**: `add-json-parser-tool`  
**最后更新**: 2025-11-08

本文档记录了项目中所有重要的技术决策及其理由。

---

## ADR-001: 代码编辑器选择

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08  
**决策者**: 项目团队

### 背景
需要一个功能强大的代码编辑器来支持 JSON 编辑和语法高亮。

### 决策
使用 **Monaco Editor**

### 理由
- ✅ VS Code 同款编辑器，功能强大
- ✅ 内置 JSON 语法支持和验证
- ✅ 优秀的 TypeScript 支持
- ✅ 丰富的 API 和自定义能力
- ⚠️ 打包体积约 3MB，但可通过代码分割和懒加载优化

### 替代方案
- **CodeMirror 6**: 更轻量（~500KB），但功能相对简单，需要更多自定义开发
- **Ace Editor**: 成熟但社区活跃度较低

### 后果
- 需要实现代码分割和懒加载
- 首次加载时间会略长，但体验更好

---

## ADR-002: 文件大小限制

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策
```typescript
const WARN_FILE_SIZE = 5 * 1024 * 1024;  // 5MB - 显示警告
const MAX_FILE_SIZE = 20 * 1024 * 1024;  // 20MB - 硬性限制
const WORKER_THRESHOLD = 10 * 1024 * 1024; // 10MB - 强制使用 Web Worker
```

### 理由
- 5MB 以下：常规处理，性能良好
- 5-10MB：显示警告，用户知情同意
- 10-20MB：自动使用 Web Worker 后台处理
- 超过 20MB：拒绝处理，建议分割文件

### 性能目标
- < 100KB: < 500ms
- 100KB - 1MB: < 1s
- 1MB - 10MB: < 3s
- 10MB - 20MB: < 5s

---

## ADR-003: UI 组件库

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策
使用 **shadcn/ui** + 自定义核心组件

### 组件分配
```
shadcn/ui 提供:
- Button (基础按钮)
- Toast (通知提示)
- Select (下拉选择)
- Dialog (对话框)

自定义实现:
- JSONInput (Monaco Editor 集成)
- JSONViewer (JSON 渲染器)
- FoldableNode (折叠节点)
- StatusBar (状态栏)
```

### 理由
- shadcn/ui 提供高质量基础组件，加速开发
- 核心业务组件自定义，保证灵活性
- 所有组件都是 Tailwind CSS，样式一致

---

## ADR-004: 虚拟滚动

**状态**: ⏸️ 延后决策  
**决策日期**: 2025-11-08

### 决策
第一版 **不实现** 虚拟滚动，在 Phase 7 性能测试后根据实际需求决定。

### 触发条件（如果需要实现）
- JSON 格式化后 **超过 1000 行**
- 渲染时间 **超过 2 秒**
- 用户明确反馈性能问题

### 备选方案
- **react-window**: 轻量级，API 简洁（首选）
- **react-virtualized**: 功能更多，但体积较大

### 重新评估时间
Phase 7 性能测试阶段（Week 4）

---

## ADR-005: 错误提示方式

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策

#### Toast 通知（自动消失）
```
✅ 成功操作: 3秒后自动消失
⚠️ 警告信息: 5秒后自动消失 + 手动关闭
ℹ️ 普通信息: 3秒后自动消失
```

#### 固定错误面板（手动关闭）
```
位置: 输入区域正下方
触发: JSON 解析错误
内容: 错误消息 + 行号列号 + 错误位置高亮
操作: 点击跳转 + 手动关闭
```

### 交互流程
1. 用户输入 JSON
2. 实时解析（防抖 500ms）
3. 如有错误：
   - Monaco Editor 显示红色波浪线
   - 固定面板显示错误详情
   - 点击错误可跳转到对应位置
4. 操作成功：Toast 提示

---

## ADR-006: 测试框架

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策

```yaml
单元测试: Vitest
组件测试: React Testing Library
E2E测试: Playwright (可选)
覆盖率目标: 80%
```

### 理由
- **Vitest**: 
  - 比 Jest 快 10-20 倍
  - 与 Vite/Next.js 集成更好
  - 原生支持 ESM
  - 兼容 Jest API
  
- **React Testing Library**: 
  - 关注用户行为而非实现细节
  - 社区标准
  
- **Playwright**: 
  - 跨浏览器支持
  - 快速稳定
  - 可延后到 v1.1

### 测试策略
```
Phase 9: 测试实施
├── 单元测试 (Week 5, Day 1-2)
│   ├── lib/ 下所有工具函数
│   ├── hooks/ 下所有自定义 Hooks
│   └── 覆盖率 > 90%
│
├── 组件测试 (Week 5, Day 3-4)
│   ├── 核心组件交互
│   ├── 状态管理逻辑
│   └── 覆盖率 > 70%
│
└── E2E测试 (可选)
    └── 关键用户流程
```

---

## ADR-007: 主题支持

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策
第一版（v1.0）仅支持 **暗色主题**

### 理由
- Monaco Editor 的 `vs-dark` 主题已经很完善
- 开发者工具通常使用暗色主题
- 简化开发，加快上线速度
- 主题切换作为 v1.1 功能

### 未来扩展（v1.1）
```
功能:
- [ ] 亮色主题 (vs-light)
- [ ] 高对比度主题
- [ ] 自定义主题
- [ ] 跟随系统主题
- [ ] 主题切换动画

配置:
- 使用 localStorage 保存用户偏好
- 提供主题选择器组件
```

---

## ADR-008: 部署平台

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策
使用 **Cloudflare Pages**

### 配置
```json
{
  "production": {
    "build": {
      "command": "pnpm run build",
      "output": "out"
    },
    "env": {
      "NODE_VERSION": "18"
    }
  }
}
```

### 理由
- ✅ 免费额度充足
- ✅ 全球 CDN，访问速度快
- ✅ 自动 HTTPS
- ✅ 与 GitHub 集成，自动部署
- ✅ 支持 Next.js 静态导出

### 域名和分析（延后决策）
- 域名：暂用 Cloudflare 提供的子域名
- 分析：v1.1 考虑集成 Umami 或 Google Analytics
- CDN：Cloudflare 自带

---

## ADR-009: 状态持久化

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策

#### localStorage（跨会话，永久保存）
```typescript
配置项:
- indentSize: number (2 或 4)
- theme: string (未来使用)
- showLineNumbers: boolean
```

#### sessionStorage（仅当前会话）
```typescript
会话数据:
- foldState: Record<string, boolean>  // 折叠状态
- editorState: object                 // 编辑器状态（光标位置等）
```

#### 不持久化（隐私保护）
```typescript
敏感数据:
- inputText: string      // 用户输入的 JSON
- parsedData: any        // 解析后的数据
- history: []            // 历史记录（如果实现）
```

### 实现
```typescript
// lib/storage.ts
export const storage = {
  // 配置
  getConfig: (): Config => {...},
  setConfig: (config: Partial<Config>) => {...},
  
  // 会话状态
  getFoldState: (): FoldState => {...},
  setFoldState: (state: FoldState) => {...},
  
  // 清除所有数据
  clear: () => {...}
};
```

---

## ADR-010: 防抖策略

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策
使用 **固定 500ms** 防抖延迟

### 理由
- 500ms 是用户感知的平衡点
- 避免过于频繁的解析影响性能
- 与主流编辑器（VS Code）保持一致

### 未来优化（可选）
```typescript
// 根据文件大小动态调整
const getDebounceDelay = (fileSize: number) => {
  if (fileSize < 100 * 1024) return 300;      // < 100KB: 300ms
  if (fileSize < 1024 * 1024) return 500;     // < 1MB: 500ms
  if (fileSize < 5 * 1024 * 1024) return 800; // < 5MB: 800ms
  return 1000;                                 // >= 5MB: 1000ms
};
```

---

## ADR-011: 国际化支持

**状态**: ⏸️ 延后决策  
**决策日期**: 2025-11-08

### 决策
第一版（v1.0）仅支持 **中文**，但预留 i18n 结构

### 实现方式
```typescript
// 第一版：使用常量
const MESSAGES = {
  FORMAT_SUCCESS: '格式化成功',
  COPY_SUCCESS: '已复制到剪贴板',
  PARSE_ERROR: 'JSON 解析失败',
  // ...
};

// 未来：使用 i18n 库
// import { useTranslation } from 'next-intl';
// const { t } = useTranslation();
// t('FORMAT_SUCCESS')
```

### v1.1 规划
- 英文支持
- 使用 `next-intl` 或 `react-i18next`
- 支持语言切换
- URL 参数控制语言（`?lang=en`）

---

## ADR-012: 无障碍性实现

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策
实现 **基础无障碍** 功能，符合 WCAG 2.1 AA 标准

### 必须实现（v1.0）
```
✅ 键盘导航
- Tab 键在可交互元素间移动
- Enter/Space 激活按钮
- Esc 关闭弹窗

✅ ARIA 标签
- 所有按钮有 aria-label
- 表单元素有 label 关联
- 状态变化有 aria-live 公告

✅ 颜色对比度
- 文本对比度 >= 4.5:1
- 大文本对比度 >= 3:1

✅ 焦点指示器
- 明显的焦点边框
- 对比度 >= 3:1
```

### 延后实现（v1.1+）
```
⏸️ 屏幕阅读器优化
⏸️ 高对比度模式
⏸️ 字体大小调整
⏸️ 键盘快捷键
```

### 测试工具
- Chrome Lighthouse
- axe DevTools
- WAVE Browser Extension

---

## ADR-013: 监控和分析

**状态**: ⏸️ 延后决策  
**决策日期**: 2025-11-08

### 决策
第一版（v1.0）**不集成**任何分析或监控工具

### 理由
- 确保用户隐私
- 简化开发流程
- 避免额外依赖
- 加快上线速度

### v1.1 考虑方案

#### 选项 1: 隐私优先（推荐）
```yaml
分析工具: Umami (自托管)
错误追踪: 无（仅控制台日志）
性能监控: Web Vitals API (本地)
```

#### 选项 2: 功能完整
```yaml
分析工具: Google Analytics 4
错误追踪: Sentry (免费计划)
性能监控: Vercel Analytics
```

### 前提条件
- 必须有明确的隐私政策
- 用户可选择退出
- 不收集敏感数据（JSON 内容）

---

## ADR-014: Web Worker 触发条件

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策

```typescript
const shouldUseWorker = (fileSize: number): boolean => {
  return fileSize >= 10 * 1024 * 1024; // >= 10MB
};
```

### 工作流程
```
文件大小检测
├── < 10MB: 主线程同步处理
└── >= 10MB: Web Worker 异步处理
    ├── 显示加载进度
    ├── 可取消操作
    └── 完成后返回主线程
```

### 理由
- 10MB 以下主线程处理速度足够快
- 10MB 以上可能阻塞 UI，需要后台处理
- 避免过早优化，降低复杂度

### 性能预期
```
主线程处理 (< 10MB):
- 1MB: ~200ms
- 5MB: ~1s
- 10MB: ~2.5s

Web Worker 处理 (>= 10MB):
- 15MB: ~4s
- 20MB: ~5s
```

---

## ADR-015: 响应式断点

**状态**: ✅ 已接受  
**决策日期**: 2025-11-08

### 决策

```typescript
const BREAKPOINTS = {
  mobile: 0,      // 0 - 767px
  tablet: 768,    // 768 - 1023px
  desktop: 1024,  // 1024px+
} as const;
```

### 布局策略

#### 桌面端（>= 1024px）
```
┌─────────────────────────────────────┐
│  工具栏（横向）                      │
├─────────────────┬───────────────────┤
│  输入区域 (50%) │ 输出区域 (50%)     │
└─────────────────┴───────────────────┘
│  状态栏（横向）                      │
└─────────────────────────────────────┘
```

#### 平板端（768px - 1023px）
```
┌─────────────────────────────────────┐
│  工具栏（横向，可能换行）             │
├─────────────────────────────────────┤
│  输入区域 (100%, 50vh)               │
├─────────────────────────────────────┤
│  输出区域 (100%, 50vh)               │
└─────────────────────────────────────┘
│  状态栏（横向）                      │
└─────────────────────────────────────┘
```

#### 移动端（< 768px）
```
┌─────────────────────────────────────┐
│  [输入] [输出] 标签切换              │
├─────────────────────────────────────┤
│                                     │
│  当前标签页内容                      │
│  (输入或输出)                        │
│                                     │
└─────────────────────────────────────┘
│  工具栏（图标按钮，可滚动）           │
└─────────────────────────────────────┘
│  状态栏（精简显示）                  │
└─────────────────────────────────────┘
```

### Tailwind 配置
```javascript
// tailwind.config.js
module.exports = {
  theme: {
    screens: {
      'sm': '768px',   // tablet
      'lg': '1024px',  // desktop
    }
  }
}
```

---

## 决策状态说明

- ✅ **已接受**: 已确定并开始实施
- ⏸️ **延后决策**: 暂不实施，稍后根据需求决定
- ❌ **已拒绝**: 经评估后不采用
- 🔄 **需重新评估**: 需要更多信息或讨论

---

## 决策审查计划

| 决策编号 | 审查时间 | 审查内容 |
|---------|---------|---------|
| ADR-004 | Week 4 (Phase 7) | 是否需要虚拟滚动 |
| ADR-011 | v1.1 规划 | 国际化实现方案 |
| ADR-013 | v1.1 规划 | 监控和分析工具选择 |
| ADR-007 | v1.1 规划 | 主题切换实现 |

---

**文档维护**：每次重大决策变更时更新此文档，并注明变更原因和日期。
